<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Login / Cadastro — Magaxia</title>
<style>
  body{margin:0;font-family:Arial, sans-serif;background:radial-gradient(circle at top,#4da3ff,#003bff 60%,#001a66);min-height:100vh;display:flex;align-items:center;justify-content:center;color:#000}
  .card{width:360px;padding:20px;border-radius:12px;background:rgba(255,255,255,0.85);box-shadow:0 6px 20px rgba(0,0,0,0.25)}
  h2{margin:0 0 12px;font-size:20px;text-align:center}
  input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid rgba(0,0,0,0.08);font-size:15px}
  button{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:none;cursor:pointer;background:#4da3ff;font-weight:700;color:#000}
  .link{text-align:center;margin-top:8px;color:#003bff;cursor:pointer;font-weight:700}
  .note{font-size:13px;color:#033a7a;text-align:center;margin-top:8px}
  .toast{display:none;text-align:center;padding:10px;border-radius:8px;margin-bottom:8px}
  .debug{font-size:12px;color:#666;margin-top:8px}
</style>
</head>
<body>

<div class="card" role="main" aria-live="polite">
  <h2 id="title">Entrar</h2>

  <div id="toast" class="toast"></div>

  <!-- LOGIN -->
  <div id="loginArea">
    <input id="loginUser" placeholder="Telefone ou usuário">
    <input id="loginPass" type="password" placeholder="Senha">
    <button id="btnLogin">Entrar</button>
    <div class="link" id="showRegister">Criar conta</div>
    <div class="note">Se veio por um convite, clique em "Criar conta".</div>
  </div>

  <!-- CADASTRO -->
  <div id="registerArea" style="display:none;">
    <input id="regUser" placeholder="Nome completo">
    <input id="regPhone" placeholder="Telefone">
    <input id="regPass" type="password" placeholder="Senha">
    <input id="regInvite" placeholder="Código de convite" readonly>
    <button id="btnRegister">Cadastrar</button>
    <div class="link" id="showLogin">Já tenho conta</div>
  </div>

  <div id="dbg" class="debug"></div>
</div>

<script>
/*
  Objetivos:
  - compatibilidade com formatos antigos (magaxia_users) e novo (vast_userdata)
  - preenche invite code, abre cadastro automaticamente se veio por convite
  - after login/register -> sempre index.html
  - logs claros no console e no elemento #dbg
*/

const dbg = document.getElementById('dbg');
function logDbg(...args){ console.log('[login]', ...args); dbg.textContent = args.join(' '); }

// leitura de query params
const params = new URLSearchParams(window.location.search);
let incomingCode = params.get('codigo') || params.get('invite') || '';
if(!incomingCode && params.has('codigo') && params.get('codigo')==='') {
  // caso venha ?codigo= (vazio) ainda deixamos string vazia
  incomingCode = '';
}
logDbg('location.search=', window.location.search, ' incomingCode=', incomingCode);

// elementos
const loginArea = document.getElementById('loginArea');
const registerArea = document.getElementById('registerArea');
const titleEl = document.getElementById('title');
const toast = document.getElementById('toast');

function showToast(msg, ok=false){
  toast.style.display = 'block';
  toast.style.background = ok ? '#d4ffd9' : '#ffd6d6';
  toast.textContent = msg;
  setTimeout(()=>{ toast.style.display = 'none'; }, 1800);
}

// mostrar/ocultar telas
document.getElementById('showRegister').addEventListener('click', ()=> {
  loginArea.style.display = 'none';
  registerArea.style.display = 'block';
  titleEl.textContent = 'Criar Conta';
});
document.getElementById('showLogin').addEventListener('click', ()=> {
  registerArea.style.display = 'none';
  loginArea.style.display = 'block';
  titleEl.textContent = 'Entrar';
});

// preenche código e abre cadastro se veio por convite e não está logado
try{
  if(incomingCode){
    document.getElementById('regInvite').value = incomingCode;
    // se não estiver logado, abrir cadastro
    const logged = localStorage.getItem('vast_logged');
    const isLogged = (logged === '1' || logged === 'true');
    logDbg('logged=', logged, ' isLogged=', isLogged);
    if(!isLogged){
      loginArea.style.display = 'none';
      registerArea.style.display = 'block';
      titleEl.textContent = 'Criar Conta';
      logDbg('opened register because invite present and not logged');
    } else {
      logDbg('did NOT open register: user already logged');
    }
  }
} catch(e){
  console.warn('prefill invite error', e);
}

// FUNÇÃO: obter usuário salvo suportando ambos formatos
function getStoredUsers(){
  // formato antigo: magaxia_users => { username: { senha, convite } }
  // formato novo: vast_userdata => single user object (we'll adapt)
  try{
    const old = JSON.parse(localStorage.getItem('magaxia_users') || '{}');
    const vast = JSON.parse(localStorage.getItem('vast_userdata') || 'null');
    // build unified map: key -> { senha, convite, phone? }
    const map = {};
    if(old && typeof old === 'object'){
      Object.keys(old).forEach(k => { map[k] = { senha: old[k].senha, convite: old[k].convite || '' }; });
    }
    if(vast && typeof vast === 'object'){
      // if vast has phone or user, add as key (we'll use phone as key if available)
      const key = (vast.phone || vast.user || 'default_user').toString();
      map[key] = { senha: vast.pass || vast.password || vast.passwd || vast.senha || '', convite: vast.invitedBy || vast.invited || vast.invite || '' };
      // also make a username key if vast.myCode exists
      if(vast.myCode) map[vast.myCode] = map[key];
    }
    return map;
  }catch(e){
    console.warn('getStoredUsers parse error', e);
    return {};
  }
}

// LOGIN handler
document.getElementById('btnLogin').addEventListener('click', () => {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();

  if(!u || !p){ showToast('Preencha usuário e senha'); return; }

  const users = getStoredUsers();
  logDbg('users keys:', Object.keys(users));

  // try match by exact key
  if(users[u] && users[u].senha === p){
    // success
    localStorage.setItem('vast_logged','1');
    // also keep vast_userdata normalized for compatibility
    const normalized = { user: u, phone: u, pass: p, myCode: (users[u].myCode || ''), createdAt: Date.now() };
    localStorage.setItem('vast_userdata', JSON.stringify(normalized));
    showToast('Login realizado', true);
    logDbg('login success for', u);
    // redirect ALWAYS to index.html
    setTimeout(()=> { window.location.href = 'index.html'; }, 600);
    return;
  }

  // if not found direct, attempt search by password match (some users store by phone)
  const found = Object.entries(users).find(([k,v]) => (v.senha === p && (k === u || k === document.getElementById('loginUser').value.trim())));
  if(found){
    localStorage.setItem('vast_logged','1');
    localStorage.setItem('vast_userdata', JSON.stringify({ user: found[0], phone: found[0], pass: p, createdAt: Date.now() }));
    showToast('Login realizado', true);
    setTimeout(()=> { window.location.href = 'index.html'; }, 600);
    return;
  }

  showToast('Credenciais inválidas');
  logDbg('login failed for', u);
});

// REGISTER handler (creates/merges with magaxia_users and sets vast_userdata)
document.getElementById('btnRegister').addEventListener('click', async () => {
  const name = document.getElementById('regUser').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const pass = document.getElementById('regPass').value.trim();
  const invite = document.getElementById('regInvite').value.trim();

  if(!name || !phone || !pass){ showToast('Preencha todos os campos'); return; }

  // save to magaxia_users (backwards-compatible)
  try{
    const old = JSON.parse(localStorage.getItem('magaxia_users') || '{}');
    old[phone] = { senha: pass, convite: invite, nome: name };
    localStorage.setItem('magaxia_users', JSON.stringify(old));
    logDbg('saved to magaxia_users key=', phone);
  }catch(e){ console.warn('save old format failed', e); }

  // also create/overwrite vast_userdata normalized
  const myCode = 'VAST-' + Date.now().toString(36).toUpperCase();
  const vastObj = { user: name, phone: phone, pass: pass, invitedBy: invite || null, myCode, createdAt: Date.now() };
  try{
    localStorage.setItem('vast_userdata', JSON.stringify(vastObj));
    logDbg('saved vast_userdata', vastObj);
  }catch(e){ console.warn('save vast_userdata failed', e); }

  // set logged
  localStorage.setItem('vast_logged','1');

  // Optionally attempt to write to Firestore (non-blocking):
  try{
    // only attempt if firebase is available; keep safe try/catch
    if(window.firebase === undefined){
      // we didn't import firebase here (this page may not), so skip
    }
  }catch(e){ console.warn('firestore attempt skipped', e); }

  showToast('Conta criada', true);
  setTimeout(()=> { window.location.href = 'index.html'; }, 700);
});

// extra: console.info on load
logDbg('script initialized — waiting for user actions');

</script>

</body>
</html>
