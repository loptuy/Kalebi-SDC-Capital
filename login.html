<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Login / Cadastro • Magaxia</title>
<style>
body{
  margin:0;
  padding:0;
  height:100vh;
  font-family:Arial, sans-serif;
  color:#fff;
  background:radial-gradient(circle at top,#0a1b3d 0%,#030814 70%);
  display:flex;
  align-items:center;
  justify-content:center;
}
.card{
  background:rgba(15,20,32,0.88);
  padding:30px;
  width:100%;
  max-width:420px;
  border-radius:18px;
  backdrop-filter:blur(12px);
  box-shadow:0 0 25px rgba(0,150,255,0.40);
  border:1px solid rgba(0,150,255,0.4);
}
h2{ text-align:center; margin-top:0; margin-bottom:12px; font-size:22px; color:#7ecbff; }
input{ width:100%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid rgba(0,150,255,0.28); background:rgba(10,15,26,0.85); color:#bce1ff; font-size:14px; }
button{ width:100%; padding:12px; margin-top:10px; border-radius:8px; border:none; font-weight:700; cursor:pointer; background:linear-gradient(90deg,#00aaff,#4dc4ff); color:#000; }
a{ display:block; text-align:center; margin-top:10px; color:#7ecbff; cursor:pointer; }
.hidden{ display:none; }
.toast{ position:fixed; top:18px; left:50%; transform:translateX(-50%); padding:10px 14px; border-radius:8px; color:#fff; z-index:9999; }
.small-note{ font-size:12px; color:#bce1ff; text-align:center; margin-top:6px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox" class="card" aria-live="polite">
  <h2>Entrar</h2>
  <input id="phoneLogin" type="tel" placeholder="Telefone">
  <input id="passLogin" type="password" placeholder="Senha">
  <button id="btnLogin">Entrar</button>
  <a id="linkShowRegister">Criar conta</a>
  <div class="small-note">Se veio por um convite, clique em "Criar conta" se ainda não tem cadastro.</div>
</div>

<!-- CADASTRO -->
<div id="registerBox" class="card hidden" aria-live="polite">
  <h2>Criar Conta</h2>
  <input id="userReg" type="text" placeholder="Nome de Usuário">
  <input id="phoneReg" type="tel" placeholder="Telefone">
  <input id="passReg" type="password" placeholder="Senha">
  <input id="inviteCodeReg" type="text" placeholder="Código de Convite (opcional)" readonly>
  <button id="btnRegister">Cadastrar</button>
  <a id="linkShowLogin">Já tenho conta</a>
</div>

<script type="module">
/* -------------------------------
   FIREBASE (corrigido storageBucket)
   ------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAcVPgUHbL4N9U1-H68klmGKWQF-YGleyc",
  authDomain: "vastbitloud-2872a.firebaseapp.com",
  projectId: "vastbitloud-2872a",
  storageBucket: "vastbitloud-2872a.appspot.com", // CORRETO
  messagingSenderId: "952931184412",
  appId: "1:952931184412:web:ee2a0e38826c30dd0cd4d9",
  measurementId: "G-KWVQ0CFHW2"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* -------------------------------
   UTIL: TOAST
   ------------------------------- */
function showMessage(msg, ok=false){
  const d = document.createElement('div');
  d.className = 'toast';
  d.textContent = msg;
  d.style.background = ok ? '#4CAF50' : '#ff4d4d';
  d.style.opacity = '0.98';
  document.body.appendChild(d);
  setTimeout(()=> d.remove(),2500);
}

/* -------------------------------
   ELEMENTOS & TROCA DE TELA
   ------------------------------- */
const loginBox = document.getElementById('loginBox');
const registerBox = document.getElementById('registerBox');

document.getElementById('linkShowRegister').onclick = () => {
  loginBox.classList.add('hidden');
  registerBox.classList.remove('hidden');
};

document.getElementById('linkShowLogin').onclick = () => {
  registerBox.classList.add('hidden');
  loginBox.classList.remove('hidden');
};

/* -------------------------------
   LER PARAMETROS DA URL (global)
   ------------------------------- */
const params = new URLSearchParams(window.location.search);
const next = params.get('next');                 // exemplo: 'equipe'
const incomingCode = params.get('codigo') || params.get('invite'); // codigo do convite se houver

// Preencher campo invite (readonly) - será mostrado automaticamente abaixo
if(incomingCode){
  document.getElementById('inviteCodeReg').value = incomingCode;
}

/* -------------------------------
   ABRIR CADASTRO AUTOMATICAMENTE
   se veio por convite e usuário NÃO está logado
   ------------------------------- */
(function autoOpenRegisterIfInvite(){
  try{
    const logged = localStorage.getItem('vast_logged');
    if(incomingCode && logged !== '1'){
      // abrir a tela de cadastro para o usuário ver o código
      loginBox.classList.add('hidden');
      registerBox.classList.remove('hidden');
    }
  }catch(e){}
})();

/* -------------------------------
   FUNÇÃO DE REGISTRO
   - mantém comportamento anterior
   - redireciona para `next` se existir
   ------------------------------- */
document.getElementById('btnRegister').onclick = async () => {
  const user = document.getElementById('userReg').value.trim();
  const phone = document.getElementById('phoneReg').value.trim();
  const pass = document.getElementById('passReg').value.trim();
  const invitedBy = document.getElementById('inviteCodeReg').value.trim() || null;

  if(!user || !phone || !pass){
    showMessage('Preencha todos os campos!');
    return;
  }

  const myCode = "VAST-" + Date.now().toString(36).toUpperCase();
  const localData = { user, phone, pass, myCode, invitedBy, createdAt: Date.now() };

  // salva no localStorage (fluxo leve, offline-friendly)
  localStorage.setItem('vast_userdata', JSON.stringify(localData));
  localStorage.setItem('vast_logged', '1');

  // tenta gravar no Firestore somente se houver invitedBy (não quebra se falhar)
  if(invitedBy){
    try{
      await addDoc(collection(db, "teams"), {
        owner: invitedBy,
        member: myCode,
        memberName: user,
        phone: phone,
        createdAt: Date.now()
      });
    }catch(e){
      console.warn('Erro ao gravar team (não bloqueante):', e);
    }
  }

  showMessage('Conta criada com sucesso!', true);

  // redireciona respeitando o 'next' caso exista
  setTimeout(()=>{
    if(next === 'equipe') window.location.href = 'equipe.html';
    else if(next === 'perfil') window.location.href = 'perfil.html';
    else window.location.href = 'index.html';
  }, 700);
};

/* -------------------------------
   LOGIN
   - respeita 'next' na query
   ------------------------------- */
document.getElementById('btnLogin').onclick = () => {
  const phone = document.getElementById('phoneLogin').value.trim();
  const pass = document.getElementById('passLogin').value.trim();
  const stored = JSON.parse(localStorage.getItem('vast_userdata') || 'null');

  if(stored && phone === stored.phone && pass === stored.pass){
    localStorage.setItem('vast_logged','1');
    showMessage('Login realizado!', true);

    setTimeout(()=>{
      if(next === 'equipe') window.location.href = 'equipe.html';
      else if(next === 'perfil') window.location.href = 'perfil.html';
      else window.location.href = 'index.html';
    }, 700);

  } else {
    showMessage('Telefone ou senha incorretos!');
  }
};

/* -------------------------------
   AUTO-LOGIN SE JÁ ESTIVER LOGADO
   - NÃO APAGA A QUERYSTRING
   - redireciona de acordo com 'next'
   ------------------------------- */
window.addEventListener('load', () => {
  try{
    const logged = localStorage.getItem('vast_logged');
    if(logged === '1'){
      // se veio com ?next=..., vai diretamente para o destino
      if(next === 'equipe'){
        window.location.href = 'equipe.html';
        return;
      }
      if(next === 'perfil'){
        window.location.href = 'perfil.html';
        return;
      }
      // sem next -> vai ao index
      window.location.href = 'index.html';
    }
  }catch(e){}
});
</script>

</body>
</html>
